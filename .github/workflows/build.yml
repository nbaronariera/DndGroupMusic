name: Build and Release

on:
  push:
    tags:
      - 'v*'
permissions:
  contents: write

env:
  RUST_BINARY_NAME: DndGroupMusic

jobs:
  build-windows:
    name: Build Windows (Bundled)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build Release
        run: cargo build --release --verbose

      - name: Create Distribution Dir
        run: |
          New-Item -ItemType Directory -Force -Path .\dist
          Copy-Item .\target\release\${{ env.RUST_BINARY_NAME }}.exe -Destination .\dist\

      - name: Download yt-dlp
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile ".\dist\yt-dlp.exe"

      - name: Download and setup ffmpeg
        shell: powershell
        run: |
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          Invoke-WebRequest -Uri $url -OutFile "ffmpeg.zip"
          Expand-Archive -Path "ffmpeg.zip" -DestinationPath "ffmpeg_temp" -Force
          $bin = Get-ChildItem -Path "ffmpeg_temp" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          Copy-Item -Path $bin.FullName -Destination ".\dist\ffmpeg.exe"

      - name: Zip Windows Bundle
        run: Compress-Archive -Path .\dist\* -DestinationPath .\MarkdownMusicDownloader_Win64.zip

      - name: Upload Windows Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: MarkdownMusicDownloader_Win64.zip
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev

      - name: Build Release
        run: cargo build --release --verbose

      - name: Prepare Linux Artifact
        run: |
          mkdir -p dist
          cp target/release/${{ env.RUST_BINARY_NAME }} dist/
          cd dist
          tar -czvf ../music-downloader-linux.tar.gz ${{ env.RUST_BINARY_NAME }}

      - name: Upload Linux Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: music-downloader-linux.tar.gz
